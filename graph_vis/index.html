<body>
    <label for="graph_input">Choose the graph data json file:</label>
    <input type="file" id="graph_input" name="graph_input" accept="application/json" />
    <label for="info_input">Choose the meta information json file:</label>
    <input type="file" id="info_input" name="info_input" accept="application/json" />
    <button id="render_button" disabled>Render Graph</button>
    <div id="container" style="width: 100%; height: 100%; align-items: center;"></div>
</body>

<script src="https://unpkg.com/@antv/g6@5/dist/g6.min.js"></script>
<script>
    
    const { Graph } = G6;
    const graph_input = document.getElementById("graph_input");
    const info_input = document.getElementById("info_input");
    const graph_reader = new FileReader();
    const info_reader = new FileReader();
    const render_button = document.getElementById("render_button");

    render_button.disabled = true;
    
    let graphFileUploaded = false;
    let infoFileUploaded = false;
    let graphData = null;
    let metaInfo = null;

    const enableButtonIfReady = () => {
        if (graphFileUploaded && infoFileUploaded) {
            render_button.disabled = false;
        }
    };

    graph_input.onchange = (event) => {
        const file = event.target.files[0];
        if (file) {
            graph_reader.readAsText(file);
        }
    };

    info_input.onchange = (event) => {
        const file = event.target.files[0];
        if (file) {
            info_reader.readAsText(file);
        }
    };

    graph_reader.onload = (event) => {
        graphFileUploaded = true;
        graphData = JSON.parse(event.target.result);
        enableButtonIfReady();
    };

    info_reader.onload = (event) => {
        infoFileUploaded = true;
        metaInfo = JSON.parse(event.target.result);
        enableButtonIfReady();
    };

    render_button.onclick = () => {
        if (graphData && metaInfo) {
            const dataNames = metaInfo.data_names;

            for (let i = 0; i < graphData.nodes.length; i++) {
                graphData.nodes[i].style = {
                    size: 10,
                    icon: true,
                    iconText: graphData.nodes[i].id,
                    iconFontSize: 5,
                    iconFill: '#000',
                };
            }
            for (let i = 0; i < graphData.edges.length; i++) {
                const edgeArg = graphData.edges[i].args;
                const argName = Object.keys(edgeArg)[0]; // fow now only one edge required arg being considered 
                if (!dataNames.includes(argName)) {
                    graphData.edges[i].style = {
                        lineDash: 1,
                    };
                }
            }
            console.log(graphData);
            console.log(metaInfo);
            showGraph(graphData);
        }
    };

    var showGraph = data => {
        const graph = new Graph({
            container: 'container',
            autoFit: 'view',
            autoResize: true,
            data,
            node: {
                palette: {
                    field: 'group',
                    color: 'tableau',
                },
            },
            edge: {
                style: {
                    haloLineWidth: 8,
                    endArrow: true,
                    endArrowSize: 2,
                },
            },
            layout: {
                type: 'dendrogram',
                direction: 'LR',
                nodeSep: 20,
                rankSep: 50,
                radial: false,
            },
            behaviors: [
                'zoom-canvas', 'drag-element',
                'hover-activate',
                {
                    type: 'click-select',
                    key: 'click-select-1',
                    multiple: true,
                },
                {
                    type: 'drag-canvas',
                    key: 'drag-canvas-1',   
                },
            ],
            plugins: [
                {
                    type: 'tooltip',
                    trigger: 'hover',
                    getContent: (e, _item) => {
                        const { targetType, target } = e;
                        const item = _item[0];
                        if (targetType == 'node') {
                            let content = `
                                <div style="word-wrap:break-word;">
                                    <p>API: ${item.api}<p>
                                    <p>products: ${item.products}<p>
                                </div>
                            `;
                            return content;
                        } else if (targetType == 'edge') {
                            let content = `
                                <div style="word-wrap:break-word;">
                                    <p>dependencies: ${item.dependencies}<p>
                                    <p>args: ${JSON.stringify(item.args)}<p>
                                    <p>arg_types: ${JSON.stringify(item.arg_types)}<p>
                                </div>
                            `;
                            return content;
                        }
                        return null;
                    }
                },
                {
                    key: 'minimap',
                    type: 'minimap',
                    size: [240, 160],
                    position: 'right-bottom'
                },
            ]
        });
        
        graph.render();
    };
    
</script>



